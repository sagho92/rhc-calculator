<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RHC Hemodynamic Calculator</title>
<style>
  :root {
    --navy: #0d2240;
    --blue: #1565c0;
    --light-bg: #f4f6f9;
    --card-bg: #ffffff;
    --border: #d0d8e0;
    --green: #2e7d32;
    --red: #c62828;
    --amber: #ef6c00;
    --yellow-bg: #fffde7;
    --red-bg: #fce4ec;
    --green-bg: #e8f5e9;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.4;
    color: #1a1a1a;
    background: var(--light-bg);
  }

  /* HEADER */
  .header {
    background: var(--navy);
    color: #fff;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .header h1 { font-size: 18px; font-weight: 700; letter-spacing: 0.3px; }
  .header-btns { display: flex; gap: 8px; }
  .header-btns button {
    background: rgba(255,255,255,0.12);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    padding: 5px 14px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: background 0.2s, border-color 0.2s;
  }
  .header-btns button:hover { background: rgba(255,255,255,0.22); border-color: rgba(255,255,255,0.4); }

  /* LAYOUT */
  .container {
    display: flex;
    gap: 0;
    height: calc(100vh - 48px);
  }
  .panel {
    overflow-y: auto;
    padding: 16px;
  }
  .panel-left {
    flex: 1;
    border-right: 1px solid var(--border);
    background: #fff;
    min-width: 420px;
  }
  .panel-right {
    flex: 1;
    background: var(--light-bg);
    min-width: 420px;
  }

  /* SECTIONS */
  .section {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    transition: box-shadow 0.2s;
  }
  .section:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .section-head {
    background: var(--navy);
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    padding: 7px 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .section-body { padding: 10px 14px; }

  /* INPUT GROUPS */
  .input-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }
  .input-row label {
    font-weight: 700;
    font-size: 13px;
    color: var(--navy);
    min-width: 52px;
  }
  .input-group {
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .input-group .sep {
    color: #999;
    font-weight: 700;
    font-size: 16px;
  }
  .input-group .label-sm {
    font-size: 11px;
    color: #777;
    min-width: 32px;
  }
  input[type="number"] {
    width: 68px;
    padding: 5px 6px;
    border: 1px solid var(--border);
    border-radius: 5px;
    font-size: 14px;
    font-family: "SF Mono", "Menlo", monospace;
    text-align: center;
    background: #fafbfc;
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
  }
  input[type="number"]:focus {
    outline: none;
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(21,101,192,0.12);
    background: #fff;
  }
  input[type="number"]::placeholder { color: #c0c0c0; font-size: 11px; }
  .unit { font-size: 11px; color: #888; margin-left: 2px; }

  /* SELECTS & CHECKBOXES */
  select {
    padding: 5px 8px;
    border: 1px solid var(--border);
    border-radius: 5px;
    font-size: 13px;
    background: #fafbfc;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  select:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(21,101,192,0.12); }
  .check-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    margin: 4px 0;
  }
  .check-row input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }

  .radio-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 6px 0;
    font-size: 13px;
  }
  .radio-row label { min-width: auto; font-weight: 600; cursor: pointer; }
  .radio-row input[type="radio"] { cursor: pointer; }

  .subsection { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin: 8px 0 4px 0; font-weight: 700; border-bottom: 1px solid #eee; padding-bottom: 2px; }

  /* RESULTS */
  .result-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 4px 6px;
    margin: 0 -6px;
    border-bottom: 1px solid #f0f2f5;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .result-row:hover { background: rgba(21,101,192,0.03); }
  .result-row:last-child { border-bottom: none; }
  .result-label {
    font-weight: 600;
    font-size: 13px;
    color: #444;
    min-width: 80px;
  }
  .result-value {
    font-family: "SF Mono", "Menlo", monospace;
    font-size: 15px;
    font-weight: 700;
    min-width: 100px;
  }
  .result-unit { font-size: 12px; color: #888; }
  .result-range { font-size: 11px; color: #aaa; font-style: italic; }
  .result-flag {
    font-size: 11px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 10px;
    letter-spacing: 0.2px;
    transition: all 0.2s;
  }
  .flag-low { background: #fce4ec; color: var(--red); }
  .flag-high { background: #fff3e0; color: var(--amber); }
  .flag-severe { background: #ffcdd2; color: #b71c1c; }
  .flag-normal { background: #e8f5e9; color: var(--green); }

  .val-normal { color: var(--green); }
  .val-abnormal { color: var(--red); }
  .val-borderline { color: var(--amber); }
  .val-na { color: #bbb; }

  /* WARNINGS */
  .warning-box {
    background: var(--yellow-bg);
    border-left: 3px solid #f9a825;
    padding: 6px 10px;
    margin: 6px 0;
    font-size: 12px;
    border-radius: 0 4px 4px 0;
  }
  .error-box {
    background: var(--red-bg);
    border-left: 3px solid var(--red);
    padding: 6px 10px;
    margin: 6px 0;
    font-size: 12px;
    border-radius: 0 4px 4px 0;
  }
  .info-box {
    background: #e3f2fd;
    border-left: 3px solid var(--blue);
    padding: 6px 10px;
    margin: 6px 0;
    font-size: 12px;
    border-radius: 0 4px 4px 0;
  }

  /* COPY SECTION */
  .copy-section {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-top: 12px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }
  .copy-head {
    background: #2c3e50;
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    padding: 8px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .copy-btn {
    background: #43a047;
    color: #fff;
    border: none;
    padding: 5px 18px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 700;
    transition: background 0.2s, transform 0.1s;
  }
  .copy-btn:hover { background: #388e3c; }
  .copy-btn:active { transform: scale(0.97); }
  .copy-btn.copied { background: #1565c0; }
  #copyText {
    width: 100%;
    min-height: 300px;
    padding: 12px 14px;
    font-family: "SF Mono", "Menlo", "Courier New", monospace;
    font-size: 12px;
    line-height: 1.55;
    border: none;
    resize: vertical;
    color: #333;
    background: #fafbfc;
  }

  /* HELPERS */
  .hint { font-size: 11px; color: #999; margin-top: 2px; }
  .divider { border-top: 1px solid #e0e0e0; margin: 8px 0; }
  .flex-gap { display: flex; gap: 12px; flex-wrap: wrap; }
  .bold { font-weight: 700; }

  /* TD RUNS */
  .td-runs { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
  .td-runs input { width: 62px; }

  @media (max-width: 900px) {
    .container { flex-direction: column; height: auto; }
    .panel-left, .panel-right { min-width: unset; border-right: none; }
    .panel-left { border-bottom: 2px solid var(--border); }
  }

  /* DARK MODE */
  body.dark {
    --light-bg: #1a1d23;
    --card-bg: #23272e;
    --border: #3a3f4b;
    --navy: #151b28;
    color: #d8dce4;
  }
  body.dark .header { background: #101520; box-shadow: 0 2px 12px rgba(0,0,0,0.4); }
  body.dark .panel-left { background: #1e2128; border-right-color: #3a3f4b; }
  body.dark .panel-right { background: #1a1d23; }
  body.dark .section { border-color: #3a3f4b; background: #23272e; }
  body.dark .section-head { background: #1a2236; }
  body.dark input[type="number"] {
    background: #2a2e37; border-color: #3a3f4b; color: #d8dce4;
  }
  body.dark input[type="number"]:focus {
    border-color: #4a90d9; box-shadow: 0 0 0 2px rgba(74,144,217,0.2); background: #2e323c;
  }
  body.dark input[type="number"]::placeholder { color: #6a7080; }
  body.dark select { background: #2a2e37; border-color: #3a3f4b; color: #d8dce4; }
  body.dark .input-row label { color: #8ab4f8; }
  body.dark .result-label { color: #b0b8c4; }
  body.dark .result-range { color: #8890a0; }
  body.dark .result-unit { color: #8890a0; }
  body.dark .result-row { border-bottom-color: #2e323c; }
  body.dark .hint { color: #8890a0; }
  body.dark .label-sm { color: #9098a8; }
  body.dark .sep { color: #788; }
  body.dark .unit { color: #8890a0; }
  body.dark .subsection { color: #9098a8; border-bottom-color: #3a3f4b; }
  body.dark .divider { border-top-color: #333; }
  body.dark .warning-box { background: #332b1a; border-left-color: #b8860b; color: #e8d5a0; }
  body.dark .error-box { background: #331a1a; border-left-color: #c62828; color: #e8a0a0; }
  body.dark .info-box { background: #1a2533; border-left-color: #4a90d9; color: #a0c4e8; }
  body.dark .copy-head { background: #1a1d23; }
  body.dark #copyText { background: #1e2128; color: #d0d4dc; border-top: 1px solid #333; }
  body.dark .flag-low { background: #3d1f2a; color: #ef9a9a; }
  body.dark .flag-high { background: #3d2f1f; color: #ffcc80; }
  body.dark .flag-severe { background: #4a1a1a; color: #ef5350; }
  body.dark .flag-normal { background: #1f3d2a; color: #81c784; }
  body.dark .val-normal { color: #66bb6a; }
  body.dark .val-abnormal { color: #ef5350; }
  body.dark .val-borderline { color: #ffa726; }
</style>
</head>
<body>

<div class="header">
  <h1>RHC Hemodynamic Calculator</h1>
  <div class="header-btns">
    <button onclick="loadExample()">Load Example</button>
    <button onclick="clearAll()">Clear All</button>
    <button id="darkToggle" onclick="toggleDark()">Dark Mode</button>
  </div>
</div>

<div class="container">

<!-- ==================== LEFT PANEL: INPUTS ==================== -->
<div class="panel panel-left">

  <!-- PATIENT CONSTANTS -->
  <div class="section">
    <div class="section-head">Patient / Constants</div>
    <div class="section-body">
      <div class="input-row">
        <label>Age</label>
        <input type="number" id="age" step="1" placeholder="yrs" oninput="calc()">
        <span class="unit">years</span>
        &nbsp;&nbsp;
        <label>Sex</label>
        <select id="sex" onchange="calc()">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
        &nbsp;&nbsp;
        <label>BSA</label>
        <input type="number" id="bsa" step="0.01" placeholder="m²" oninput="calc()">
        <span class="unit">m²</span>
      </div>
      <div class="input-row">
        <label>Hb<sub>CBC</sub></label>
        <input type="number" id="hb" step="0.1" placeholder="g/dL" oninput="calc()">
        <span class="unit">g/dL</span>
        &nbsp;&nbsp;
        <label>HR</label>
        <input type="number" id="hr" step="1" placeholder="bpm" oninput="calc()">
        <span class="unit">bpm</span>
      </div>
      <div class="input-row">
        <label>O₂ const</label>
        <select id="o2const" onchange="calc()">
          <option value="1.36" selected>1.36 mL O₂/g Hb</option>
          <option value="1.34">1.34 mL O₂/g Hb</option>
        </select>
        <div class="check-row" style="margin-left:12px;">
          <input type="checkbox" id="useDissolvedO2" onchange="calc()">
          <label for="useDissolvedO2" style="font-weight:400; min-width:auto; cursor:pointer;">Include dissolved O₂</label>
        </div>
      </div>
    </div>
  </div>

  <!-- EQUIPMENT -->
  <div class="section">
    <div class="section-head">Access &amp; Equipment</div>
    <div class="section-body">
      <div class="input-row">
        <label>Venous sheath</label>
        <select id="venous_sheath" onchange="calc()">
          <option value="">—</option>
          <option value="6">6 Fr</option>
          <option value="7">7 Fr</option>
          <option value="8" selected>8 Fr</option>
          <option value="8.5">8.5 Fr</option>
          <option value="9">9 Fr</option>
        </select>
        &nbsp;&nbsp;
        <label>PA catheter</label>
        <select id="pa_catheter" onchange="calc()">
          <option value="">—</option>
          <option value="5">5 Fr (pediatric)</option>
          <option value="7">7 Fr</option>
          <option value="7.5" selected>7.5 Fr (standard Swan-Ganz)</option>
          <option value="8">8 Fr</option>
        </select>
      </div>
      <div class="input-row">
        <label>TD injectate</label>
        <select id="td_injectate" onchange="calc()">
          <option value="room_10" selected>10 mL room temp</option>
          <option value="iced_10">10 mL iced</option>
          <option value="room_5">5 mL room temp</option>
          <option value="iced_5">5 mL iced</option>
        </select>
        <span class="hint" style="margin-left:8px;" id="compConstHint">Computation constant must match catheter + injectate in monitor</span>
      </div>
      <div class="info-box" style="font-size:11px; margin-top:4px;">
        <b>Why this matters:</b> The TD computation constant programmed in the hemodynamic monitor is specific to catheter size + injectate volume/temperature. A mismatch produces systematic TD CO error. Verify the constant matches your setup. This does <b>not</b> affect Fick or LaFarge calculations.
      </div>
    </div>
  </div>

  <!-- PRESSURES -->
  <div class="section">
    <div class="section-head">Pressures (mmHg)</div>
    <div class="section-body">

      <div class="input-row">
        <label>RA</label>
        <div class="input-group">
          <span class="label-sm">a</span>
          <input type="number" id="ra_a" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">v</span>
          <input type="number" id="ra_v" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">mean</span>
          <input type="number" id="ra_mean" step="1" oninput="calc()">
        </div>
      </div>

      <div class="input-row">
        <label>RV</label>
        <div class="input-group">
          <span class="label-sm">sys</span>
          <input type="number" id="rv_sys" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">dia</span>
          <input type="number" id="rv_dia" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">EDP</span>
          <input type="number" id="rv_edp" step="1" oninput="calc()">
        </div>
      </div>

      <div class="input-row">
        <label>PA</label>
        <div class="input-group">
          <span class="label-sm">sys</span>
          <input type="number" id="pa_sys" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">dia</span>
          <input type="number" id="pa_dia" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">mean</span>
          <input type="number" id="pa_mean" step="1" oninput="calc()">
        </div>
      </div>

      <div class="input-row">
        <label>PCWP</label>
        <div class="input-group">
          <span class="label-sm">a</span>
          <input type="number" id="pcwp_a" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">v</span>
          <input type="number" id="pcwp_v" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">mean</span>
          <input type="number" id="pcwp_mean" step="1" oninput="calc()">
        </div>
      </div>

      <div class="input-row">
        <label>Aorta</label>
        <div class="input-group">
          <span class="label-sm">sys</span>
          <input type="number" id="ao_sys" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">dia</span>
          <input type="number" id="ao_dia" step="1" oninput="calc()">
          <span class="sep">/</span>
          <span class="label-sm">mean</span>
          <input type="number" id="ao_mean" step="1" oninput="calc()">
        </div>
      </div>

    </div>
  </div>

  <!-- OXIMETRY -->
  <div class="section">
    <div class="section-head">Oximetry</div>
    <div class="section-body">
      <div class="input-row">
        <label>SaO₂</label>
        <input type="number" id="sao2" step="0.1" placeholder="%" oninput="calc()">
        <span class="unit">%</span>
        &nbsp;&nbsp;
        <label>SvO₂</label>
        <input type="number" id="svo2" step="0.1" placeholder="%" oninput="calc()">
        <span class="unit">% (PA sat)</span>
      </div>
      <div class="input-row" id="dissolvedRow" style="display:none;">
        <label>PaO₂</label>
        <input type="number" id="pao2" step="1" placeholder="mmHg" oninput="calc()">
        <span class="unit">mmHg</span>
        &nbsp;&nbsp;
        <label>PvO₂</label>
        <input type="number" id="pvo2" step="1" placeholder="mmHg" oninput="calc()">
        <span class="unit">mmHg</span>
      </div>
      <div class="hint">Enter saturations as percentages (e.g., 92.8 not 0.928). Calculator converts automatically.</div>
    </div>
  </div>

  <!-- VO2 -->
  <div class="section">
    <div class="section-head">VO₂ — Oxygen Consumption</div>
    <div class="section-body">
      <div class="input-row">
        <label>Source</label>
        <select id="vo2source" onchange="handleVo2Source(); calc();">
          <option value="lafarge">LaFarge (auto-calculated)</option>
          <option value="lafarge_manual">LaFarge (enter from cath lab software)</option>
          <option value="measured">Measured (metabolic cart)</option>
          <option value="estimated">Estimated (125 mL/min/m²)</option>
        </select>
      </div>
      <div id="lafargeCalcRow">
        <div class="info-box" style="font-size:12px; margin:4px 0;" id="lafargeDetail">
          Requires: Age, Sex, HR, BSA (from Patient section above)
        </div>
      </div>
      <div class="input-row">
        <label>VO₂</label>
        <input type="number" id="vo2" step="0.1" placeholder="mL/min" oninput="calc()" style="width:92px;">
        <span class="unit">mL O₂/min</span>
        <span class="hint" style="margin-left:6px;" id="vo2_per_m2"></span>
      </div>
      <div class="hint" id="vo2hint">LaFarge: VO₂ = [138.1 − (k × ln(age)) + (0.378 × HR)] × BSA &nbsp; (k = 11.49 M, 17.04 F)</div>
    </div>
  </div>

  <!-- THERMODILUTION -->
  <div class="section">
    <div class="section-head">Thermodilution</div>
    <div class="section-body">
      <div class="input-row">
        <label>Runs</label>
        <div class="td-runs">
          <input type="number" id="td1" step="0.01" placeholder="#1" oninput="calcTD(); calc();">
          <input type="number" id="td2" step="0.01" placeholder="#2" oninput="calcTD(); calc();">
          <input type="number" id="td3" step="0.01" placeholder="#3" oninput="calcTD(); calc();">
          <input type="number" id="td4" step="0.01" placeholder="#4" oninput="calcTD(); calc();">
          <input type="number" id="td5" step="0.01" placeholder="#5" oninput="calcTD(); calc();">
          <span class="unit">L/min each</span>
        </div>
      </div>
      <div class="input-row">
        <label>TD CO</label>
        <input type="number" id="td_co" step="0.01" placeholder="avg" oninput="calc()">
        <span class="unit">L/min (avg)</span>
        <span class="hint" style="margin-left:8px;" id="tdAvgHint"></span>
      </div>
    </div>
  </div>

  <!-- CO SOURCE FOR DERIVED -->
  <div class="section">
    <div class="section-head">CO Source for Derived Hemodynamics</div>
    <div class="section-body">
      <div class="radio-row">
        <input type="radio" name="coSource" id="coFick" value="fick" checked onchange="calc()">
        <label for="coFick">Fick CO (recommended)</label>
        <input type="radio" name="coSource" id="coTD" value="td" onchange="calc()">
        <label for="coTD">Thermodilution CO</label>
      </div>
    </div>
  </div>

  <!-- GORLIN VALVE AREA INPUTS -->
  <div class="section">
    <div class="section-head">Gorlin Valve Area Calculations (Optional)</div>
    <div class="section-body">

      <div class="subsection">Aortic Valve (AVA)</div>
      <div class="input-row">
        <label>Mean ΔP</label>
        <input type="number" id="ava_gradient" step="0.1" placeholder="mmHg" oninput="calc()">
        <span class="unit">mmHg (transaortic gradient)</span>
      </div>
      <div class="input-row">
        <label>Eject time</label>
        <input type="number" id="ava_ejtime" step="0.01" placeholder="sec/beat" oninput="calcSEP(); calc();">
        <span class="unit">sec/beat</span>
        <span style="margin:0 6px; color:#999;">→</span>
        <label>SEP</label>
        <input type="number" id="ava_sep" step="0.1" placeholder="sec/min" oninput="calc()">
        <span class="unit">sec/min</span>
      </div>
      <div class="hint">SEP = ejection time/beat × HR. Typical: 0.30–0.35 sec/beat → 20–25 sec/min. Measured from AV open to dicrotic notch.</div>

      <div class="subsection" style="margin-top:10px;">Mitral Valve (MVA)</div>
      <div class="input-row">
        <label>Mean ΔP</label>
        <input type="number" id="mva_gradient" step="0.1" placeholder="mmHg" oninput="calc()">
        <span class="unit">mmHg (transmitral gradient)</span>
      </div>
      <div class="input-row">
        <label>Fill time</label>
        <input type="number" id="mva_filltime" step="0.01" placeholder="sec/beat" oninput="calcDFP(); calc();">
        <span class="unit">sec/beat</span>
        <span style="margin:0 6px; color:#999;">→</span>
        <label>DFP</label>
        <input type="number" id="mva_dfp" step="0.1" placeholder="sec/min" oninput="calc()">
        <span class="unit">sec/min</span>
      </div>
      <div class="hint">DFP = filling time/beat × HR. Typical: 0.40–0.50 sec/beat → 30–40 sec/min. Shortened in tachycardia. Average ≥5 beats in AFib.</div>

    </div>
  </div>

</div>

<!-- ==================== RIGHT PANEL: RESULTS ==================== -->
<div class="panel panel-right">

  <!-- O2 CONTENT -->
  <div class="section">
    <div class="section-head">O₂ Content</div>
    <div class="section-body">
      <div class="result-row">
        <span class="result-label">CaO₂</span>
        <span class="result-value" id="r_cao2">—</span>
        <span class="result-unit">mL O₂/dL</span>
      </div>
      <div class="result-row">
        <span class="result-label">CvO₂</span>
        <span class="result-value" id="r_cvo2">—</span>
        <span class="result-unit">mL O₂/dL</span>
      </div>
      <div class="result-row">
        <span class="result-label">a-vO₂ diff</span>
        <span class="result-value" id="r_avo2">—</span>
        <span class="result-unit">mL O₂/dL</span>
        <span class="result-range">normal: 3.5–5.0</span>
      </div>
    </div>
  </div>

  <!-- FICK CO -->
  <div class="section">
    <div class="section-head">Fick Cardiac Output</div>
    <div class="section-body">
      <div class="result-row">
        <span class="result-label">Fick CO</span>
        <span class="result-value" id="r_fick_co">—</span>
        <span class="result-unit">L/min</span>
        <span class="result-range">normal: 4–8</span>
        <span class="result-flag" id="f_fick_co"></span>
      </div>
      <div class="result-row">
        <span class="result-label">Fick CI</span>
        <span class="result-value" id="r_fick_ci">—</span>
        <span class="result-unit">L/min/m²</span>
        <span class="result-range">normal: 2.5–4.0</span>
        <span class="result-flag" id="f_fick_ci"></span>
      </div>
      <div class="result-row">
        <span class="result-label">SV</span>
        <span class="result-value" id="r_sv">—</span>
        <span class="result-unit">mL/beat</span>
        <span class="result-range">normal: 60–100</span>
        <span class="result-flag" id="f_sv"></span>
      </div>
      <div class="result-row">
        <span class="result-label">SVI</span>
        <span class="result-value" id="r_svi">—</span>
        <span class="result-unit">mL/beat/m²</span>
        <span class="result-range">normal: 33–47</span>
        <span class="result-flag" id="f_svi"></span>
      </div>
    </div>
  </div>

  <!-- TD CO -->
  <div class="section">
    <div class="section-head">Thermodilution</div>
    <div class="section-body">
      <div class="result-row">
        <span class="result-label">TD CO</span>
        <span class="result-value" id="r_td_co">—</span>
        <span class="result-unit">L/min</span>
        <span class="result-range">normal: 4–8</span>
      </div>
      <div class="result-row">
        <span class="result-label">TD CI</span>
        <span class="result-value" id="r_td_ci">—</span>
        <span class="result-unit">L/min/m²</span>
        <span class="result-range">normal: 2.5–4.0</span>
      </div>
      <div id="tdFickWarning"></div>
    </div>
  </div>

  <!-- PULMONARY HEMODYNAMICS -->
  <div class="section">
    <div class="section-head">Pulmonary Hemodynamics <span style="font-weight:400; text-transform:none; font-size:11px;" id="derivedLabel">(using Fick CO)</span></div>
    <div class="section-body">
      <div class="result-row">
        <span class="result-label">TPG</span>
        <span class="result-value" id="r_tpg">—</span>
        <span class="result-unit">mmHg</span>
        <span class="result-range">mPAP − PCWP</span>
      </div>
      <div class="result-row">
        <span class="result-label">DPG</span>
        <span class="result-value" id="r_dpg">—</span>
        <span class="result-unit">mmHg</span>
        <span class="result-range">normal: ≤ 7; &gt;7 → pre-cap component</span>
      </div>
      <div class="result-row">
        <span class="result-label">PVR</span>
        <span class="result-value" id="r_pvr">—</span>
        <span class="result-unit">WU</span>
        <span class="result-range">normal: &lt; 2</span>
        <span class="result-flag" id="f_pvr"></span>
      </div>
      <div class="result-row">
        <span class="result-label">PVR</span>
        <span class="result-value" id="r_pvr_dyn">—</span>
        <span class="result-unit">dyn·s·cm⁻⁵</span>
      </div>
      <div class="result-row">
        <span class="result-label">PVRI</span>
        <span class="result-value" id="r_pvri">—</span>
        <span class="result-unit">WU·m²</span>
      </div>
      <div id="phClassification"></div>
    </div>
  </div>

  <!-- SYSTEMIC HEMODYNAMICS -->
  <div class="section">
    <div class="section-head">Systemic Hemodynamics <span style="font-weight:400; text-transform:none; font-size:11px;" id="derivedLabel2">(using Fick CO)</span></div>
    <div class="section-body">
      <div class="result-row">
        <span class="result-label">SVR</span>
        <span class="result-value" id="r_svr">—</span>
        <span class="result-unit">WU</span>
        <span class="result-range">normal: 10–20</span>
        <span class="result-flag" id="f_svr"></span>
      </div>
      <div class="result-row">
        <span class="result-label">SVR</span>
        <span class="result-value" id="r_svr_dyn">—</span>
        <span class="result-unit">dyn·s·cm⁻⁵</span>
        <span class="result-range">normal: 800–1600</span>
      </div>
      <div class="result-row">
        <span class="result-label">SVRI</span>
        <span class="result-value" id="r_svri">—</span>
        <span class="result-unit">WU·m²</span>
      </div>
    </div>
  </div>

  <!-- RV PERFORMANCE -->
  <div class="section">
    <div class="section-head">RV Performance &amp; Shock Indices</div>
    <div class="section-body">
      <div class="result-row">
        <span class="result-label">PAPi</span>
        <span class="result-value" id="r_papi">—</span>
        <span class="result-unit">(unitless)</span>
        <span class="result-range">&gt;1.0 adequate; &lt;0.9 RV failure risk</span>
        <span class="result-flag" id="f_papi"></span>
      </div>
      <div class="result-row">
        <span class="result-label">RVSWI</span>
        <span class="result-value" id="r_rvswi">—</span>
        <span class="result-unit">g·m/m²/beat</span>
        <span class="result-range">normal: 5–10</span>
        <span class="result-flag" id="f_rvswi"></span>
      </div>
      <div class="result-row">
        <span class="result-label">CPO</span>
        <span class="result-value" id="r_cpo">—</span>
        <span class="result-unit">Watts</span>
        <span class="result-range">normal: ~1; &lt;0.6 poor prognosis</span>
        <span class="result-flag" id="f_cpo"></span>
      </div>
      <div class="result-row">
        <span class="result-label">CPI</span>
        <span class="result-value" id="r_cpi">—</span>
        <span class="result-unit">W/m²</span>
        <span class="result-range">&lt;0.33 strongest predictor of mortality</span>
        <span class="result-flag" id="f_cpi"></span>
      </div>
    </div>
  </div>

  <!-- GORLIN VALVE AREA RESULTS -->
  <div class="section" id="gorlinResultsSection" style="display:none;">
    <div class="section-head">Gorlin Valve Areas <span style="font-weight:400; text-transform:none; font-size:11px;" id="gorlinCoLabel">(using Fick CO)</span></div>
    <div class="section-body">

      <div id="avaResults" style="display:none;">
        <div style="font-weight:700; font-size:12px; color:var(--navy); margin-bottom:2px;">Aortic Valve Area (AVA)</div>
        <div class="result-row">
          <span class="result-label">AVA</span>
          <span class="result-value" id="r_ava">—</span>
          <span class="result-unit">cm²</span>
          <span class="result-range">normal: &gt; 2.0</span>
          <span class="result-flag" id="f_ava"></span>
        </div>
        <div style="font-size:11px; color:#666; margin:2px 0;" id="ava_math"></div>
        <table class="vals" style="font-size:7.5pt; margin:4px 0;">
          <tr><th>Severity</th><th>AVA (cm²)</th></tr>
          <tr><td>Normal</td><td>&gt; 2.0</td></tr>
          <tr><td>Mild AS</td><td>1.5 – 2.0</td></tr>
          <tr><td>Moderate AS</td><td>1.0 – 1.5</td></tr>
          <tr class="severe"><td>Severe AS</td><td>&lt; 1.0</td></tr>
          <tr class="severe"><td>Critical AS</td><td>≤ 0.6</td></tr>
        </table>
      </div>

      <div id="mvaResults" style="display:none;">
        <div style="font-weight:700; font-size:12px; color:var(--navy); margin:6px 0 2px 0; border-top:1px solid #eee; padding-top:6px;">Mitral Valve Area (MVA)</div>
        <div class="result-row">
          <span class="result-label">MVA</span>
          <span class="result-value" id="r_mva">—</span>
          <span class="result-unit">cm²</span>
          <span class="result-range">normal: 4 – 6</span>
          <span class="result-flag" id="f_mva"></span>
        </div>
        <div style="font-size:11px; color:#666; margin:2px 0;" id="mva_math"></div>
        <table class="vals" style="font-size:7.5pt; margin:4px 0;">
          <tr><th>Severity</th><th>MVA (cm²)</th></tr>
          <tr><td>Normal</td><td>4 – 6</td></tr>
          <tr><td>Mild MS</td><td>&gt; 1.5</td></tr>
          <tr><td>Moderate MS</td><td>1.0 – 1.5</td></tr>
          <tr class="severe"><td>Severe MS</td><td>&lt; 1.0</td></tr>
        </table>
      </div>

      <div class="pearl-box" style="font-size:11px; margin-top:4px;">
        <b>Gorlin is flow-dependent.</b> Low CO → falsely small valve area. Tachycardia → major effect on MVA (short DFP), minimal on AVA. Use Fick CO for Gorlin.
      </div>

    </div>
  </div>

  <!-- QUALITY CHECKS -->
  <div class="section">
    <div class="section-head">Quality Checks</div>
    <div class="section-body" id="qualityChecks">
      <div class="info-box">Enter values to see quality checks.</div>
    </div>
  </div>

  <!-- COPY SECTION -->
  <div class="copy-section">
    <div class="copy-head">
      <span>COPY-PASTE REPORT</span>
      <div style="display:flex; align-items:center; gap:12px;">
        <label style="display:flex; align-items:center; gap:5px; font-weight:400; font-size:11px; cursor:pointer; min-width:auto; color:#ccc;">
          <input type="checkbox" id="plainTextToggle" onchange="calc()" style="width:14px; height:14px; cursor:pointer;">
          Plain text (EHR)
        </label>
        <button class="copy-btn" id="copyBtn" onclick="copyResults()">Copy to Clipboard</button>
      </div>
    </div>
    <textarea id="copyText" readonly></textarea>
  </div>

</div>

</div>

<script>
// ===================== HELPERS =====================
function v(id) {
  const el = document.getElementById(id);
  const val = parseFloat(el.value);
  return isNaN(val) ? null : val;
}
function fmt(val, dec) {
  if (val === null || val === undefined || isNaN(val) || !isFinite(val)) return '—';
  return val.toFixed(dec === undefined ? 2 : dec);
}
function setText(id, text) { document.getElementById(id).textContent = text; }
function setFlag(id, text, cls) {
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = 'result-flag' + (cls ? ' ' + cls : '');
}
function clearFlag(id) { setFlag(id, '', ''); }

// ===================== TD AVERAGE =====================
function calcTD() {
  const runs = [];
  for (let i = 1; i <= 5; i++) {
    const val = v('td' + i);
    if (val !== null && val > 0) runs.push(val);
  }
  if (runs.length > 0) {
    const avg = runs.reduce((a, b) => a + b, 0) / runs.length;
    document.getElementById('td_co').value = avg.toFixed(2);
    document.getElementById('tdAvgHint').textContent = `(avg of ${runs.length} runs)`;
  } else {
    document.getElementById('tdAvgHint').textContent = '';
  }
}

// ===================== SEP / DFP AUTO-CALC =====================
function calcSEP() {
  const ejTime = v('ava_ejtime');
  const hr = v('hr');
  if (ejTime !== null && hr !== null && hr > 0) {
    document.getElementById('ava_sep').value = (ejTime * hr).toFixed(1);
  }
}
function calcDFP() {
  const fillTime = v('mva_filltime');
  const hr = v('hr');
  if (fillTime !== null && hr !== null && hr > 0) {
    document.getElementById('mva_dfp').value = (fillTime * hr).toFixed(1);
  }
}

// ===================== VO2 SOURCE =====================
function handleVo2Source() {
  const src = document.getElementById('vo2source').value;
  const hint = document.getElementById('vo2hint');
  const lafargeRow = document.getElementById('lafargeCalcRow');
  const vo2Input = document.getElementById('vo2');

  if (src === 'lafarge') {
    hint.textContent = 'LaFarge: VO₂ = [138.1 − (k × ln(age)) + (0.378 × HR)] × BSA   (k = 11.49 M, 17.04 F)';
    lafargeRow.style.display = 'block';
    vo2Input.readOnly = true;
    vo2Input.style.background = '#e8f5e9';
    calcLaFarge();
  } else if (src === 'lafarge_manual') {
    hint.textContent = 'Document: "estimated VO₂ via LaFarge equation (cath lab software)"';
    lafargeRow.style.display = 'none';
    vo2Input.readOnly = false;
    vo2Input.style.background = '#fafbfc';
  } else if (src === 'measured') {
    hint.textContent = 'Document: "measured VO₂ via metabolic cart"';
    lafargeRow.style.display = 'none';
    vo2Input.readOnly = false;
    vo2Input.style.background = '#fafbfc';
  } else {
    hint.textContent = 'VO₂ = 125 × BSA. Less accurate — use LaFarge if available.';
    lafargeRow.style.display = 'none';
    vo2Input.readOnly = false;
    vo2Input.style.background = '#fafbfc';
    const bsa = v('bsa');
    if (bsa) {
      vo2Input.value = (125 * bsa).toFixed(1);
    }
  }
}

function calcLaFarge() {
  const src = document.getElementById('vo2source').value;
  if (src !== 'lafarge') return;

  const age = v('age');
  const hr = v('hr');
  const bsa = v('bsa');
  const sex = document.getElementById('sex').value;
  const detail = document.getElementById('lafargeDetail');
  const perM2 = document.getElementById('vo2_per_m2');

  if (age === null || age <= 0 || hr === null || hr <= 0 || bsa === null || bsa <= 0) {
    detail.innerHTML = '<b>LaFarge auto-calc:</b> Needs Age, HR, and BSA above. Fill those in and VO₂ will compute automatically.';
    detail.className = 'info-box';
    document.getElementById('vo2').value = '';
    perM2.textContent = '';
    return;
  }

  const k = (sex === 'female') ? 17.04 : 11.49;
  const vo2_per_m2 = 138.1 - (k * Math.log(age)) + (0.378 * hr);
  const vo2_total = vo2_per_m2 * bsa;

  document.getElementById('vo2').value = vo2_total.toFixed(1);
  perM2.textContent = `(${vo2_per_m2.toFixed(1)} mL/min/m²)`;

  const sexLabel = sex === 'female' ? 'F' : 'M';
  detail.innerHTML = `<b>LaFarge (${sexLabel}):</b> [138.1 − (${k} × ln(${age})) + (0.378 × ${hr})] × ${bsa} = <b>${vo2_total.toFixed(1)} mL/min</b>`;
  detail.className = 'info-box';
  detail.style.fontSize = '12px';
}

// ===================== DISSOLVED O2 TOGGLE =====================
document.getElementById('useDissolvedO2').addEventListener('change', function() {
  document.getElementById('dissolvedRow').style.display = this.checked ? 'flex' : 'none';
});

// ===================== MAIN CALCULATION =====================
function calc() {
  // --- Auto-calculate LaFarge if selected, and SEP/DFP from HR ---
  calcLaFarge();
  calcSEP();
  calcDFP();

  // --- Get inputs ---
  const bsa = v('bsa');
  const hb = v('hb');
  const hr = v('hr');
  const o2k = parseFloat(document.getElementById('o2const').value);
  const useDissolved = document.getElementById('useDissolvedO2').checked;

  const ra_a = v('ra_a'), ra_v = v('ra_v'), ra_mean = v('ra_mean');
  const rv_sys = v('rv_sys'), rv_dia = v('rv_dia'), rv_edp = v('rv_edp');
  const pa_sys = v('pa_sys'), pa_dia = v('pa_dia'), pa_mean = v('pa_mean');
  const pcwp_a = v('pcwp_a'), pcwp_v = v('pcwp_v'), pcwp_mean = v('pcwp_mean');
  const ao_sys = v('ao_sys'), ao_dia = v('ao_dia'), ao_mean = v('ao_mean');

  const sao2_pct = v('sao2'), svo2_pct = v('svo2');
  const sao2 = sao2_pct !== null ? sao2_pct / 100 : null;
  const svo2 = svo2_pct !== null ? svo2_pct / 100 : null;
  const pao2 = v('pao2'), pvo2 = v('pvo2');

  const vo2 = v('vo2');
  const td_co = v('td_co');

  const useFick = document.getElementById('coFick').checked;

  // --- O2 Content ---
  let cao2 = null, cvo2 = null, avo2 = null;
  if (hb !== null && sao2 !== null) {
    cao2 = hb * o2k * sao2;
    if (useDissolved && pao2 !== null) cao2 += 0.0031 * pao2;
  }
  if (hb !== null && svo2 !== null) {
    cvo2 = hb * o2k * svo2;
    if (useDissolved && pvo2 !== null) cvo2 += 0.0031 * pvo2;
  }
  if (cao2 !== null && cvo2 !== null) avo2 = cao2 - cvo2;

  setText('r_cao2', fmt(cao2));
  setText('r_cvo2', fmt(cvo2));
  setText('r_avo2', fmt(avo2));

  // --- Fick CO ---
  let fickCO = null, fickCI = null, sv = null, svi = null;
  if (vo2 !== null && avo2 !== null && avo2 > 0) {
    fickCO = vo2 / (avo2 * 10);
  }
  if (fickCO !== null && bsa !== null && bsa > 0) fickCI = fickCO / bsa;
  if (fickCO !== null && hr !== null && hr > 0) sv = (fickCO * 1000) / hr;
  if (sv !== null && bsa !== null && bsa > 0) svi = sv / bsa;

  setText('r_fick_co', fmt(fickCO));
  setText('r_fick_ci', fmt(fickCI));
  setText('r_sv', fmt(sv, 1));
  setText('r_svi', fmt(svi, 1));

  // Fick flags
  flagValue('f_fick_co', fickCO, 4, 8, 'L/min');
  flagValue('f_fick_ci', fickCI, 2.5, 4.0, 'CI');
  flagValue('f_sv', sv, 60, 100, 'SV');
  flagValue('f_svi', svi, 33, 47, 'SVI');

  // --- TD ---
  let tdCI = null;
  if (td_co !== null && bsa !== null && bsa > 0) tdCI = td_co / bsa;
  setText('r_td_co', td_co !== null ? fmt(td_co) : '—');
  setText('r_td_ci', fmt(tdCI));

  // Fick vs TD warning
  const tdWarn = document.getElementById('tdFickWarning');
  if (fickCO !== null && td_co !== null && fickCO > 0 && td_co > 0) {
    const diff = Math.abs(fickCO - td_co) / fickCO * 100;
    if (diff > 20) {
      tdWarn.innerHTML = `<div class="warning-box"><b>Fick–TD discordance: ${fmt(diff,0)}%.</b> Consider: VO₂ estimated vs measured? Severe TR? Low-output state? Use Fick for derived hemodynamics.</div>`;
    } else {
      tdWarn.innerHTML = `<div class="info-box">Fick–TD difference: ${fmt(diff,0)}% — concordant.</div>`;
    }
  } else {
    tdWarn.innerHTML = '';
  }

  // --- Select CO for derived ---
  const co = useFick ? fickCO : td_co;
  const ci = useFick ? fickCI : tdCI;
  const coLabel = useFick ? '(using Fick CO)' : '(using TD CO)';
  setText('derivedLabel', coLabel);
  setText('derivedLabel2', coLabel);

  // --- Pulmonary hemodynamics ---
  let tpg = null, dpg = null, pvr = null, pvrDyn = null, pvri = null;
  if (pa_mean !== null && pcwp_mean !== null) tpg = pa_mean - pcwp_mean;
  if (pa_dia !== null && pcwp_mean !== null) dpg = pa_dia - pcwp_mean;
  if (tpg !== null && co !== null && co > 0) pvr = tpg / co;
  if (pvr !== null) pvrDyn = pvr * 80;
  if (tpg !== null && ci !== null && ci > 0) pvri = tpg / ci;

  setText('r_tpg', fmt(tpg, 0));
  setText('r_dpg', fmt(dpg, 0));
  setText('r_pvr', fmt(pvr));
  setText('r_pvr_dyn', fmt(pvrDyn, 0));
  setText('r_pvri', fmt(pvri));

  flagPVR('f_pvr', pvr);

  // PH classification
  const phDiv = document.getElementById('phClassification');
  if (pa_mean !== null && pcwp_mean !== null && pvr !== null) {
    if (pa_mean > 20) {
      let phType = '';
      if (pcwp_mean <= 15 && pvr > 2) phType = 'Pre-capillary PH';
      else if (pcwp_mean > 15 && pvr <= 2) phType = 'Isolated post-capillary PH (IpcPH)';
      else if (pcwp_mean > 15 && pvr > 2) phType = 'Combined pre & post-capillary PH (CpcPH)';
      else phType = 'Elevated mPAP with normal PCWP and PVR — exercise PH or borderline';
      phDiv.innerHTML = `<div class="warning-box"><b>PH Classification (2022 ESC/ERS):</b> ${phType}</div>`;
    } else {
      phDiv.innerHTML = `<div class="info-box">mPAP ≤ 20 — no pulmonary hypertension by hemodynamic criteria.</div>`;
    }
  } else {
    phDiv.innerHTML = '';
  }

  // --- Systemic hemodynamics ---
  let svr = null, svrDyn = null, svri = null;
  if (ao_mean !== null && ra_mean !== null && co !== null && co > 0) {
    svr = (ao_mean - ra_mean) / co;
  }
  if (svr !== null) svrDyn = svr * 80;
  if (ao_mean !== null && ra_mean !== null && ci !== null && ci > 0) {
    svri = (ao_mean - ra_mean) / ci;
  }

  setText('r_svr', fmt(svr));
  setText('r_svr_dyn', fmt(svrDyn, 0));
  setText('r_svri', fmt(svri));
  flagSVR('f_svr', svr);

  // --- RV Performance ---
  let papi = null, rvswi = null, cpo = null, cpi = null;
  if (pa_sys !== null && pa_dia !== null && ra_mean !== null && ra_mean > 0) {
    papi = (pa_sys - pa_dia) / ra_mean;
  }
  if (pa_mean !== null && ra_mean !== null && svi !== null) {
    rvswi = (pa_mean - ra_mean) * svi * 0.0136;
  }
  if (ao_mean !== null && co !== null) {
    cpo = (ao_mean * co) / 451;
  }
  if (ao_mean !== null && ci !== null) {
    cpi = (ao_mean * ci) / 451;
  }

  setText('r_papi', fmt(papi));
  setText('r_rvswi', fmt(rvswi));
  setText('r_cpo', fmt(cpo));
  setText('r_cpi', fmt(cpi));

  flagPAPi('f_papi', papi, ra_mean);
  flagValue('f_rvswi', rvswi, 5, 10, 'RVSWI');
  flagCPO('f_cpo', cpo);
  flagCPI('f_cpi', cpi);

  // --- Gorlin Valve Areas ---
  const ava_gradient = v('ava_gradient');
  const ava_sep = v('ava_sep');
  const mva_gradient = v('mva_gradient');
  const mva_dfp = v('mva_dfp');

  let ava = null, mva = null;
  const gorlinSection = document.getElementById('gorlinResultsSection');
  const avaDiv = document.getElementById('avaResults');
  const mvaDiv = document.getElementById('mvaResults');
  const gorlinCoLabel = document.getElementById('gorlinCoLabel');
  gorlinCoLabel.textContent = coLabel;

  let showGorlin = false;

  // AVA
  if (ava_gradient !== null && ava_gradient > 0 && ava_sep !== null && ava_sep > 0 && co !== null && co > 0) {
    const sqrtG = Math.sqrt(ava_gradient);
    ava = (co * 1000) / (44.3 * ava_sep * sqrtG);
    setText('r_ava', fmt(ava));
    flagAVA('f_ava', ava);
    document.getElementById('ava_math').textContent =
      `= (${fmt(co)} × 1000) / (44.3 × ${fmt(ava_sep,1)} × √${fmt(ava_gradient,1)}) = ${fmt(co*1000,0)} / (44.3 × ${fmt(ava_sep,1)} × ${fmt(sqrtG)}) = ${fmt(co*1000,0)} / ${fmt(44.3 * ava_sep * sqrtG,0)} = ${fmt(ava)} cm²`;
    avaDiv.style.display = 'block';
    showGorlin = true;
  } else {
    setText('r_ava', '—');
    clearFlag('f_ava');
    document.getElementById('ava_math').textContent = '';
    avaDiv.style.display = (ava_gradient !== null || ava_sep !== null) ? 'block' : 'none';
    if (ava_gradient !== null || ava_sep !== null) showGorlin = true;
  }

  // MVA
  if (mva_gradient !== null && mva_gradient > 0 && mva_dfp !== null && mva_dfp > 0 && co !== null && co > 0) {
    const sqrtG = Math.sqrt(mva_gradient);
    mva = (co * 1000) / (37.7 * mva_dfp * sqrtG);
    setText('r_mva', fmt(mva));
    flagMVA('f_mva', mva);
    document.getElementById('mva_math').textContent =
      `= (${fmt(co)} × 1000) / (37.7 × ${fmt(mva_dfp,1)} × √${fmt(mva_gradient,1)}) = ${fmt(co*1000,0)} / (37.7 × ${fmt(mva_dfp,1)} × ${fmt(sqrtG)}) = ${fmt(co*1000,0)} / ${fmt(37.7 * mva_dfp * sqrtG,0)} = ${fmt(mva)} cm²`;
    mvaDiv.style.display = 'block';
    showGorlin = true;
  } else {
    setText('r_mva', '—');
    clearFlag('f_mva');
    document.getElementById('mva_math').textContent = '';
    mvaDiv.style.display = (mva_gradient !== null || mva_dfp !== null) ? 'block' : 'none';
    if (mva_gradient !== null || mva_dfp !== null) showGorlin = true;
  }

  gorlinSection.style.display = showGorlin ? 'block' : 'none';

  // --- Quality Checks ---
  buildQualityChecks(hb, sao2, svo2, avo2, fickCO, td_co, vo2, ra_mean, papi);

  // --- Copy text ---
  buildCopyText(bsa, hb, hr, o2k, useDissolved,
    ra_a, ra_v, ra_mean, rv_sys, rv_dia, rv_edp,
    pa_sys, pa_dia, pa_mean, pcwp_a, pcwp_v, pcwp_mean,
    ao_sys, ao_dia, ao_mean, sao2_pct, svo2_pct,
    cao2, cvo2, avo2, vo2, fickCO, fickCI, sv, svi,
    td_co, tdCI, tpg, dpg, pvr, pvrDyn, pvri, svr, svrDyn, svri,
    papi, rvswi, cpo, cpi, useFick,
    ava, mva, ava_gradient, ava_sep, mva_gradient, mva_dfp);
}

// ===================== FLAG HELPERS =====================
function flagValue(id, val, lo, hi, label) {
  if (val === null || val === undefined || isNaN(val)) { clearFlag(id); return; }
  if (val < lo) setFlag(id, 'LOW', 'flag-low');
  else if (val > hi) setFlag(id, 'HIGH', 'flag-high');
  else setFlag(id, 'Normal', 'flag-normal');
}
function flagPVR(id, val) {
  if (val === null) { clearFlag(id); return; }
  if (val < 2) setFlag(id, 'Normal', 'flag-normal');
  else if (val <= 3) setFlag(id, 'Borderline', 'flag-high');
  else if (val <= 5) setFlag(id, 'Moderate', 'flag-high');
  else setFlag(id, 'SEVERE', 'flag-severe');
}
function flagSVR(id, val) {
  if (val === null) { clearFlag(id); return; }
  if (val < 10) setFlag(id, 'LOW', 'flag-low');
  else if (val <= 20) setFlag(id, 'Normal', 'flag-normal');
  else setFlag(id, 'HIGH', 'flag-high');
}
function flagPAPi(id, val, rap) {
  if (val === null) { clearFlag(id); return; }
  if (rap !== null && rap < 3) { setFlag(id, 'Unreliable (low RAP)', 'flag-high'); return; }
  if (val < 0.9) setFlag(id, 'RV failure risk', 'flag-severe');
  else if (val < 1.0) setFlag(id, 'Borderline', 'flag-high');
  else setFlag(id, 'Adequate', 'flag-normal');
}
function flagCPO(id, val) {
  if (val === null) { clearFlag(id); return; }
  if (val < 0.6) setFlag(id, 'CRITICAL', 'flag-severe');
  else if (val < 0.8) setFlag(id, 'LOW', 'flag-low');
  else setFlag(id, 'Normal', 'flag-normal');
}
function flagCPI(id, val) {
  if (val === null) { clearFlag(id); return; }
  if (val < 0.33) setFlag(id, 'CRITICAL', 'flag-severe');
  else if (val < 0.5) setFlag(id, 'LOW', 'flag-low');
  else setFlag(id, 'Normal', 'flag-normal');
}

function flagAVA(id, val) {
  if (val === null) { clearFlag(id); return; }
  if (val <= 0.6) setFlag(id, 'Critical AS', 'flag-severe');
  else if (val < 1.0) setFlag(id, 'Severe AS', 'flag-severe');
  else if (val < 1.5) setFlag(id, 'Moderate AS', 'flag-high');
  else if (val <= 2.0) setFlag(id, 'Mild AS', 'flag-high');
  else setFlag(id, 'Normal', 'flag-normal');
}
function flagMVA(id, val) {
  if (val === null) { clearFlag(id); return; }
  if (val < 1.0) setFlag(id, 'Severe MS', 'flag-severe');
  else if (val <= 1.5) setFlag(id, 'Moderate MS', 'flag-high');
  else if (val <= 4.0) setFlag(id, 'Mild MS', 'flag-high');
  else setFlag(id, 'Normal', 'flag-normal');
}
function avaLabel(val) {
  if (val <= 0.6) return 'Critical AS (≤ 0.6)';
  if (val < 1.0) return 'Severe AS (< 1.0)';
  if (val < 1.5) return 'Moderate AS (1.0–1.5)';
  if (val <= 2.0) return 'Mild AS (1.5–2.0)';
  return 'Normal (> 2.0)';
}
function mvaLabel(val) {
  if (val < 1.0) return 'Severe MS (< 1.0)';
  if (val <= 1.5) return 'Moderate MS (1.0–1.5)';
  if (val <= 4.0) return 'Mild MS (> 1.5)';
  return 'Normal (4–6)';
}

// ===================== QUALITY CHECKS =====================
function buildQualityChecks(hb, sao2, svo2, avo2, fickCO, td_co, vo2, ra_mean, papi) {
  const el = document.getElementById('qualityChecks');
  const checks = [];

  if (sao2 !== null && sao2 > 1) {
    checks.push({type:'error', msg:'SaO₂ > 100% — check input. Did you enter as fraction instead of percentage?'});
  }
  if (svo2 !== null && svo2 > 1) {
    checks.push({type:'error', msg:'SvO₂ > 100% — check input.'});
  }
  if (sao2 !== null && svo2 !== null && svo2 >= sao2) {
    checks.push({type:'error', msg:'SvO₂ ≥ SaO₂ — mixed venous sat cannot exceed arterial. Check samples.'});
  }
  if (avo2 !== null) {
    if (avo2 > 5.5) checks.push({type:'warn', msg:`Wide a-vO₂ difference (${fmt(avo2)}) — suggests low cardiac output.`});
    else if (avo2 < 3.5) checks.push({type:'warn', msg:`Narrow a-vO₂ difference (${fmt(avo2)}) — high output state, shunt, or sampling error?`});
    else checks.push({type:'ok', msg:`a-vO₂ difference (${fmt(avo2)}) is in normal range.`});
  }
  if (fickCO !== null && td_co !== null && fickCO > 0 && td_co > 0) {
    const diff = Math.abs(fickCO - td_co) / fickCO * 100;
    if (diff > 20) {
      checks.push({type:'warn', msg:`Fick–TD discordance ${fmt(diff,0)}%. Checklist: VO₂ estimated vs measured? TD accurate (TR, low output, shunt)? Mixed venous truly from PA?`});
    }
  }
  if (vo2 !== null && document.getElementById('vo2source').value === 'estimated') {
    checks.push({type:'warn', msg:'VO₂ estimated at 125 mL/min/m². ±25% error common. Use LaFarge if available.'});
  }
  if (ra_mean !== null && ra_mean < 3 && papi !== null) {
    checks.push({type:'warn', msg:'RAP < 3 mmHg — PAPi may be unreliable (denominator artifact).'});
  }
  if (fickCO !== null && fickCO < 2.5) {
    checks.push({type:'warn', msg:`Very low Fick CO (${fmt(fickCO)}). Confirm: is VO₂ reasonable? Are sats from correct sites?`});
  }

  if (checks.length === 0) {
    el.innerHTML = '<div class="info-box">Enter values to see quality checks.</div>';
    return;
  }

  el.innerHTML = checks.map(c => {
    if (c.type === 'error') return `<div class="error-box">${c.msg}</div>`;
    if (c.type === 'warn') return `<div class="warning-box">${c.msg}</div>`;
    return `<div class="info-box">${c.msg}</div>`;
  }).join('');
}

// ===================== COPY TEXT =====================
function buildCopyText(bsa, hb, hr, o2k, useDissolved,
  ra_a, ra_v, ra_mean, rv_sys, rv_dia, rv_edp,
  pa_sys, pa_dia, pa_mean, pcwp_a, pcwp_v, pcwp_mean,
  ao_sys, ao_dia, ao_mean, sao2_pct, svo2_pct,
  cao2, cvo2, avo2, vo2, fickCO, fickCI, sv, svi,
  td_co, tdCI, tpg, dpg, pvr, pvrDyn, pvri, svr, svrDyn, svri,
  papi, rvswi, cpo, cpi, useFick,
  ava, mva, ava_gradient, ava_sep, mva_gradient, mva_dfp) {

  const vo2src = document.getElementById('vo2source');
  const vo2label = vo2src.options[vo2src.selectedIndex].text;
  const coMethod = useFick ? 'Fick CO' : 'TD CO';
  const n = (val, dec) => (val !== null && val !== undefined && !isNaN(val) && isFinite(val)) ? val.toFixed(dec === undefined ? 2 : dec) : '—';

  // Equipment info
  const sheathEl = document.getElementById('venous_sheath');
  const cathEl = document.getElementById('pa_catheter');
  const injEl = document.getElementById('td_injectate');
  const sheathFr = sheathEl.value ? sheathEl.options[sheathEl.selectedIndex].text : '';
  const cathFr = cathEl.value ? cathEl.options[cathEl.selectedIndex].text : '';
  const injLabel = injEl.options[injEl.selectedIndex].text;

  let t = '';
  t += 'RIGHT HEART CATHETERIZATION\n';

  // Equipment line
  if (sheathFr || cathFr) {
    let equipLine = 'Equipment: ';
    if (sheathFr) equipLine += `Venous sheath ${sheathFr}`;
    if (sheathFr && cathFr) equipLine += ', ';
    if (cathFr) equipLine += `PA catheter ${cathFr}`;
    equipLine += `, TD injectate: ${injLabel}`;
    t += equipLine + '\n';
  }

  t += '\nHemodynamics\n';
  if (ra_a !== null || ra_mean !== null)
    t += `RA ${n(ra_a,0)}/${n(ra_v,0)}/${n(ra_mean,0)} mmHg\n`;
  if (rv_sys !== null)
    t += `RV ${n(rv_sys,0)}/${n(rv_dia,0)}/${n(rv_edp,0)} mmHg\n`;
  if (pa_sys !== null)
    t += `PA ${n(pa_sys,0)}/${n(pa_dia,0)} mean ${n(pa_mean,0)} mmHg\n`;
  if (pcwp_a !== null || pcwp_mean !== null)
    t += `PCWP ${n(pcwp_a,0)}/${n(pcwp_v,0)} mean ${n(pcwp_mean,0)} mmHg\n`;
  if (ao_sys !== null)
    t += `AO ${n(ao_sys,0)}/${n(ao_dia,0)} mean ${n(ao_mean,0)} mmHg\n`;
  if (hr !== null) t += `HR ${n(hr,0)} bpm\n`;
  if (bsa !== null) t += `BSA ${n(bsa)} m²\n`;

  // Age/Sex
  const age = v('age');
  const sex = document.getElementById('sex').value;

  t += '\nOximetry\n';
  if (sao2_pct !== null) t += `AO sat ${n(sao2_pct,1)}%\n`;
  if (svo2_pct !== null) t += `PA sat ${n(svo2_pct,1)}%\n`;

  if (hb !== null) {
    t += `\nHemoglobin (CBC) ${n(hb,1)} g/dL\n`;
  }

  const vo2srcVal = vo2src.value;
  if (vo2 !== null) {
    if (vo2srcVal === 'lafarge' && age !== null) {
      const k = (sex === 'female') ? 17.04 : 11.49;
      const sexLabel = sex === 'female' ? 'F' : 'M';
      t += `\nVO₂ LaFarge (${sexLabel}, age ${n(age,0)}) ${n(vo2,1)} mL/min\n`;
      t += `  = [138.1 - (${k} × ln(${n(age,0)})) + (0.378 × ${n(hr,0)})] × ${n(bsa)} = ${n(vo2,1)} mL/min\n`;
    } else {
      t += `\nVO₂ ${n(vo2,1)} mL/min (${vo2label})\n`;
    }
  }

  t += '\nFICK CARDIAC OUTPUT CALCULATION\n';
  if (hb !== null) t += `Hb (CBC): ${n(hb,1)} g/dL\n`;
  t += `O₂ binding constant: ${o2k} mL O₂/g Hb\n`;
  if (cao2 !== null) t += `CaO₂: ${n(cao2)} mL O₂/dL\n`;
  if (cvo2 !== null) t += `CvO₂: ${n(cvo2)} mL O₂/dL\n`;
  if (avo2 !== null) t += `a-vO₂ difference: ${n(avo2)} mL O₂/dL\n`;
  t += '\n';
  if (fickCO !== null) t += `Fick CO = ${n(vo2,1)} / (${n(hb,1)} × ${o2k * 10} × (${n(sao2_pct !== null ? sao2_pct/100 : null, 3)} - ${n(svo2_pct !== null ? svo2_pct/100 : null, 3)})) = ${n(fickCO)} L/min\n`;
  if (fickCI !== null) t += `Fick CI = ${n(fickCO)} / ${n(bsa)} = ${n(fickCI)} L/min/m²\n`;

  if (td_co !== null) {
    t += '\nTHERMODILUTION\n';
    t += `CO ${n(td_co)} L/min\n`;
    if (tdCI !== null) t += `CI ${n(tdCI)} L/min/m²\n`;
  }

  t += `\nDERIVED HEMODYNAMICS (using ${coMethod})\n`;
  if (sv !== null) t += `SV ${n(sv,1)} mL/beat\n`;
  if (svi !== null) t += `SVI ${n(svi,1)} mL/beat/m²\n`;
  if (tpg !== null) t += `TPG = ${n(pa_mean,0)} - ${n(pcwp_mean,0)} = ${n(tpg,0)} mmHg\n`;
  if (dpg !== null) t += `DPG = ${n(pa_dia,0)} - ${n(pcwp_mean,0)} = ${n(dpg,0)} mmHg\n`;
  if (pvr !== null) t += `PVR = ${n(tpg,0)} / ${useFick ? n(fickCO) : n(td_co)} = ${n(pvr)} Wood units\n`;
  if (pvrDyn !== null) t += `    = ${n(pvrDyn,0)} dyn·s·cm⁻⁵\n`;
  if (svr !== null) t += `SVR = (${n(ao_mean,0)} - ${n(ra_mean,0)}) / ${useFick ? n(fickCO) : n(td_co)} = ${n(svr)} Wood units\n`;
  if (svrDyn !== null) t += `    = ${n(svrDyn,0)} dyn·s·cm⁻⁵\n`;
  if (papi !== null) t += `PAPi = (${n(pa_sys,0)} - ${n(pa_dia,0)}) / ${n(ra_mean,0)} = ${n(papi)}\n`;
  if (rvswi !== null) t += `RVSWI = (${n(pa_mean,0)} - ${n(ra_mean,0)}) × ${n(svi,1)} × 0.0136 = ${n(rvswi)} g·m/m²/beat\n`;
  if (cpo !== null) t += `CPO = ${n(ao_mean,0)} × ${useFick ? n(fickCO) : n(td_co)} / 451 = ${n(cpo)} W\n`;
  if (cpi !== null) t += `CPI = ${n(ao_mean,0)} × ${useFick ? n(fickCI) : n(tdCI)} / 451 = ${n(cpi)} W/m²\n`;

  // --- Gorlin Valve Areas ---
  const coUsed = useFick ? fickCO : td_co;
  const coUsedStr = useFick ? n(fickCO) : n(td_co);

  if (ava !== null || mva !== null) {
    t += `\nGORLIN VALVE AREA CALCULATIONS (using ${coMethod}: ${coUsedStr} L/min)\n`;
  }

  if (ava !== null && ava_gradient !== null && ava_sep !== null) {
    const sqrtG = Math.sqrt(ava_gradient);
    const denom = 44.3 * ava_sep * sqrtG;
    const ejTime = v('ava_ejtime');
    t += `\nAortic Valve Area (AVA):\n`;
    t += `  Mean transaortic gradient (ΔP): ${n(ava_gradient,1)} mmHg\n`;
    if (ejTime !== null) {
      t += `  Ejection time: ${n(ejTime,2)} sec/beat × ${n(hr,0)} HR = ${n(ava_sep,1)} sec/min (SEP)\n`;
    } else {
      t += `  SEP: ${n(ava_sep,1)} sec/min\n`;
    }
    t += `  √ΔP = √${n(ava_gradient,1)} = ${n(sqrtG)}\n`;
    t += `\n`;
    t += `  AVA = (CO × 1000) / (44.3 × SEP × √ΔP)\n`;
    t += `      = (${coUsedStr} × 1000) / (44.3 × ${n(ava_sep,1)} × ${n(sqrtG)})\n`;
    t += `      = ${n(coUsed * 1000, 0)} / ${n(denom, 0)}\n`;
    t += `      = ${n(ava)} cm²\n`;
    t += `  Interpretation: ${avaLabel(ava)}\n`;
  }

  if (mva !== null && mva_gradient !== null && mva_dfp !== null) {
    const sqrtG = Math.sqrt(mva_gradient);
    const denom = 37.7 * mva_dfp * sqrtG;
    const fillTime = v('mva_filltime');
    t += `\nMitral Valve Area (MVA):\n`;
    t += `  Mean transmitral gradient (ΔP): ${n(mva_gradient,1)} mmHg\n`;
    if (fillTime !== null) {
      t += `  Filling time: ${n(fillTime,2)} sec/beat × ${n(hr,0)} HR = ${n(mva_dfp,1)} sec/min (DFP)\n`;
    } else {
      t += `  DFP: ${n(mva_dfp,1)} sec/min\n`;
    }
    t += `  √ΔP = √${n(mva_gradient,1)} = ${n(sqrtG)}\n`;
    t += `\n`;
    t += `  MVA = (CO × 1000) / (37.7 × DFP × √ΔP)\n`;
    t += `      = (${coUsedStr} × 1000) / (37.7 × ${n(mva_dfp,1)} × ${n(sqrtG)})\n`;
    t += `      = ${n(coUsed * 1000, 0)} / ${n(denom, 0)}\n`;
    t += `      = ${n(mva)} cm²\n`;
    t += `  Interpretation: ${mvaLabel(mva)}\n`;
  }

  if (document.getElementById('plainTextToggle').checked) {
    t = toPlainText(t);
  }
  document.getElementById('copyText').value = t;
}

// ===================== PLAIN TEXT CONVERSION =====================
function toPlainText(str) {
  // Subscripts → normal
  str = str.replace(/₀/g,'0').replace(/₁/g,'1').replace(/₂/g,'2').replace(/₃/g,'3')
           .replace(/₄/g,'4').replace(/₅/g,'5').replace(/₆/g,'6').replace(/₇/g,'7')
           .replace(/₈/g,'8').replace(/₉/g,'9');
  // Superscripts → normal
  str = str.replace(/⁰/g,'0').replace(/¹/g,'1').replace(/²/g,'2').replace(/³/g,'3')
           .replace(/⁴/g,'4').replace(/⁵/g,'5').replace(/⁶/g,'6').replace(/⁷/g,'7')
           .replace(/⁸/g,'8').replace(/⁹/g,'9').replace(/⁻/g,'-');
  // Middle dot (·) left as-is — standard unit separator, widely supported
  // Delta
  str = str.replace(/ΔP/g,'dP').replace(/Δ/g,'d');
  // Square root
  str = str.replace(/√/g,'sqrt');
  return str;
}

// ===================== COPY TO CLIPBOARD =====================
function copyResults() {
  const text = document.getElementById('copyText').value;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy to Clipboard'; btn.classList.remove('copied'); }, 2000);
  });
}

// ===================== LOAD EXAMPLE =====================
function loadExample() {
  document.getElementById('age').value = '65';
  document.getElementById('sex').value = 'male';
  document.getElementById('bsa').value = '1.51';
  document.getElementById('hb').value = '14.3';
  document.getElementById('hr').value = '88';
  document.getElementById('ra_a').value = '13';
  document.getElementById('ra_v').value = '22';
  document.getElementById('ra_mean').value = '16';
  document.getElementById('rv_sys').value = '41';
  document.getElementById('rv_dia').value = '6';
  document.getElementById('rv_edp').value = '12';
  document.getElementById('pa_sys').value = '47';
  document.getElementById('pa_dia').value = '22';
  document.getElementById('pa_mean').value = '32';
  document.getElementById('pcwp_a').value = '18';
  document.getElementById('pcwp_v').value = '17';
  document.getElementById('pcwp_mean').value = '15';
  document.getElementById('ao_sys').value = '121';
  document.getElementById('ao_dia').value = '77';
  document.getElementById('ao_mean').value = '96';
  document.getElementById('sao2').value = '92.8';
  document.getElementById('svo2').value = '53.6';
  document.getElementById('vo2source').value = 'lafarge';
  handleVo2Source();
  document.getElementById('venous_sheath').value = '8';
  document.getElementById('pa_catheter').value = '7.5';
  document.getElementById('td_injectate').value = 'room_10';
  document.getElementById('td1').value = '1.42';
  document.getElementById('td2').value = '1.48';
  document.getElementById('td3').value = '1.45';
  calcTD();
  calc();
}

// ===================== CLEAR ALL =====================
function clearAll() {
  document.querySelectorAll('input[type="number"]').forEach(el => el.value = '');
  document.getElementById('sex').value = 'male';
  document.getElementById('vo2source').value = 'lafarge';
  document.getElementById('o2const').value = '1.36';
  document.getElementById('useDissolvedO2').checked = false;
  document.getElementById('dissolvedRow').style.display = 'none';
  document.getElementById('coFick').checked = true;
  document.getElementById('venous_sheath').value = '8';
  document.getElementById('pa_catheter').value = '7.5';
  document.getElementById('td_injectate').value = 'room_10';
  document.getElementById('tdAvgHint').textContent = '';
  handleVo2Source();
  calc();
}

// ===================== DARK MODE =====================
function toggleDark() {
  document.body.classList.toggle('dark');
  const btn = document.getElementById('darkToggle');
  const isDark = document.body.classList.contains('dark');
  btn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
  try { localStorage.setItem('rhc_dark', isDark ? '1' : '0'); } catch(e) {}
}
// Restore preference
try {
  if (localStorage.getItem('rhc_dark') === '1') {
    document.body.classList.add('dark');
    document.getElementById('darkToggle').textContent = 'Light Mode';
  }
} catch(e) {}

// Initial setup on load
handleVo2Source();
calc();
</script>

</body>
</html>